---
# tasks/health_check.yml â€” openclaw_maintain role
#
# Runs on-demand health diagnostics against the OpenClaw gateway and
# deploys a launchd plist for scheduled deep health checks.

- name: Check gateway container is running
  ansible.builtin.command:
    cmd: docker ps --filter "name=openclaw.*gateway" --filter "status=running" -q
  become: true
  become_user: "{{ openclaw_user }}"
  register: _gateway_ps
  changed_when: false
  environment:
    PATH: "{{ homebrew_path }}:{{ ansible_env.PATH | default('/usr/bin:/bin:/usr/sbin:/sbin') }}"
  tags:
    - health_check
    - maintenance

- name: Verify gateway container status
  ansible.builtin.assert:
    that:
      - _gateway_ps.stdout | length > 0
    fail_msg: "OpenClaw gateway container is not running"
    success_msg: "OpenClaw gateway container is running"
  tags:
    - health_check
    - maintenance

- name: Check gateway is listening
  ansible.builtin.command:
    cmd: >-
      docker exec {{ _gateway_ps.stdout_lines[0] }}
      sh -c "curl -sf http://127.0.0.1:{{ openclaw_gateway_port }}/ -o /dev/null -w '%{http_code}' || true"
  become: true
  become_user: "{{ openclaw_user }}"
  register: _gateway_http
  changed_when: false
  ignore_errors: true
  when: _gateway_ps.stdout | length > 0
  environment:
    PATH: "{{ homebrew_path }}:{{ ansible_env.PATH | default('/usr/bin:/bin:/usr/sbin:/sbin') }}"
  tags:
    - health_check
    - maintenance

- name: Display health check results
  ansible.builtin.debug:
    msg: >-
      Gateway container: {{ 'running (' + _gateway_ps.stdout_lines[0][:12] + ')' if _gateway_ps.stdout | length > 0 else 'NOT RUNNING' }} |
      HTTP check: {{ 'responding' if (_gateway_http.rc | default(1)) == 0 else 'skipped or not reachable' }}
  tags:
    - health_check
    - maintenance

- name: Ensure LaunchAgents directory exists
  ansible.builtin.file:
    path: "{{ openclaw_user_home }}/Library/LaunchAgents"
    state: directory
    owner: "{{ openclaw_user }}"
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - health_check
    - maintenance

- name: Deploy launchd plist for scheduled health checks
  ansible.builtin.template:
    src: com.openclaw.healthcheck.plist.j2
    dest: "{{ openclaw_user_home }}/Library/LaunchAgents/com.openclaw.healthcheck.plist"
    owner: "{{ openclaw_user }}"
    mode: "0644"
  become: true
  become_user: "{{ openclaw_user }}"
  notify:
    - reload healthcheck schedule
    - load healthcheck schedule
  tags:
    - health_check
    - maintenance

- name: Load healthcheck launchd plist
  ansible.builtin.command:
    cmd: >-
      launchctl load -w
      {{ openclaw_user_home }}/Library/LaunchAgents/com.openclaw.healthcheck.plist
  become: true
  become_user: "{{ openclaw_user }}"
  register: _hc_load
  changed_when: _hc_load.rc == 0
  failed_when:
    - _hc_load.rc != 0
    - "'already loaded' not in (_hc_load.stderr | default(''))"
    - "'service already loaded' not in (_hc_load.stderr | default(''))"
  tags:
    - health_check
    - maintenance
