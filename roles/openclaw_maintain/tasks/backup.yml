---
# tasks/backup.yml â€” openclaw_maintain role
#
# Deploys backup scripts, launchd schedules, optional Google Drive sync
# via rclone, and provides on-demand backup and cleanup tasks.

- name: Ensure bin directory exists
  ansible.builtin.file:
    path: "{{ openclaw_user_home }}/bin"
    state: directory
    owner: "{{ openclaw_user }}"
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - backup
    - maintenance

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ openclaw_backup_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    mode: "0700"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - backup
    - maintenance

- name: Deploy backup script
  ansible.builtin.copy:
    src: openclaw-backup.sh
    dest: "{{ openclaw_user_home }}/bin/openclaw-backup.sh"
    owner: "{{ openclaw_user }}"
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - backup
    - maintenance

- name: Ensure LaunchAgents directory exists
  ansible.builtin.file:
    path: "{{ openclaw_user_home }}/Library/LaunchAgents"
    state: directory
    owner: "{{ openclaw_user }}"
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - backup
    - maintenance

- name: Deploy launchd plist for scheduled backups
  ansible.builtin.template:
    src: com.openclaw.backup.plist.j2
    dest: "{{ openclaw_user_home }}/Library/LaunchAgents/com.openclaw.backup.plist"
    owner: "{{ openclaw_user }}"
    mode: "0644"
  become: true
  become_user: "{{ openclaw_user }}"
  notify:
    - reload backup schedule
    - load backup schedule
  tags:
    - backup
    - maintenance

- name: Load backup launchd plist
  ansible.builtin.command:
    cmd: >-
      launchctl load -w
      {{ openclaw_user_home }}/Library/LaunchAgents/com.openclaw.backup.plist
  become: true
  become_user: "{{ openclaw_user }}"
  register: _backup_load
  changed_when: _backup_load.rc == 0
  failed_when:
    - _backup_load.rc != 0
    - "'already loaded' not in (_backup_load.stderr | default(''))"
    - "'service already loaded' not in (_backup_load.stderr | default(''))"
  tags:
    - backup
    - maintenance

# --- Google Drive sync via rclone ---

- name: Install rclone via Homebrew for Google Drive sync
  community.general.homebrew:
    name: rclone
    state: present
    path: /opt/homebrew/bin
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH | default('/usr/bin:/bin:/usr/sbin:/sbin') }}"
  when: openclaw_backup_gdrive_enabled | bool
  tags:
    - backup
    - maintenance

- name: Deploy Google Drive sync script
  ansible.builtin.copy:
    src: openclaw-gdrive-sync.sh
    dest: "{{ openclaw_user_home }}/bin/openclaw-gdrive-sync.sh"
    owner: "{{ openclaw_user }}"
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  when: openclaw_backup_gdrive_enabled | bool
  tags:
    - backup
    - maintenance

# --- On-demand backup and cleanup ---

- name: Run an immediate backup
  ansible.builtin.command:
    cmd: "{{ openclaw_user_home }}/bin/openclaw-backup.sh"
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    OPENCLAW_BACKUP_DIR: "{{ openclaw_backup_dir }}"
    OPENCLAW_CONFIG_DIR: "{{ openclaw_config_dir }}"
    OPENCLAW_BACKUP_RETENTION: "{{ openclaw_backup_retention_days }}"
  register: _immediate_backup
  changed_when: _immediate_backup.rc == 0
  tags:
    - backup
    - backup_now
    - maintenance

- name: Display immediate backup output
  ansible.builtin.debug:
    var: _immediate_backup.stdout_lines
  tags:
    - backup
    - backup_now
    - maintenance

- name: Clean up old backups beyond retention period
  ansible.builtin.command:
    cmd: >-
      find {{ openclaw_backup_dir }}
      -name "openclaw-backup-*.tar.gz"
      -mtime +{{ openclaw_backup_retention_days }}
      -delete
  become: true
  become_user: "{{ openclaw_user }}"
  register: _cleanup
  changed_when: false
  tags:
    - backup
    - maintenance
