---
# tasks/main.yml â€” openclaw_browser role
#
# Handles optional browser automation setup for OpenClaw.
# All tasks are gated behind openclaw_browser_enabled.
# Browser configuration is merged into openclaw.json by the
# openclaw_harden role; this role only builds the sandbox image.

- name: Browser automation setup
  when: openclaw_browser_enabled | bool
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - browser
  environment:
    PATH: "{{ homebrew_path }}:{{ ansible_env.PATH | default('/usr/bin:/bin:/usr/sbin:/sbin') }}"
  block:
    - name: Check if browser sandbox Docker image exists
      ansible.builtin.command:
        cmd: docker images -q openclaw-browser-sandbox
      register: _browser_sandbox_image
      changed_when: false

    - name: Build browser sandbox image if not present
      ansible.builtin.command:
        cmd: ./scripts/sandbox-browser-setup.sh
        chdir: "{{ openclaw_install_dir }}"
      when: _browser_sandbox_image.stdout | length == 0
      register: _browser_build_result
      changed_when: _browser_build_result.rc == 0

    - name: Note that browser config is merged by the harden role
      ansible.builtin.debug:
        msg: >-
          Browser sandbox image is ready.  Browser settings
          (CDP port: {{ openclaw_browser_cdp_port }},
          headless: {{ openclaw_browser_headless }},
          profile: {{ openclaw_browser_profile_name }})
          are merged into openclaw.json by the openclaw_harden role.
