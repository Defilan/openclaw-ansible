---
# tasks/docker_setup.yml â€” openclaw_deploy role
#
# Runs the Docker setup script to build images and generate configuration,
# then verifies that onboarding has been completed. If onboarding is missing,
# the play fails with instructions for the operator.

- name: Ensure OpenClaw config directory exists
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: staff
    mode: "0700"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - deploy

- name: Ensure OpenClaw workspace directory exists
  ansible.builtin.file:
    path: "{{ openclaw_install_dir }}/workspace"
    state: directory
    owner: "{{ openclaw_user }}"
    group: staff
    mode: "0755"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - deploy

- name: Create initial .env file for Docker Compose
  ansible.builtin.copy:
    dest: "{{ openclaw_install_dir }}/.env"
    owner: "{{ openclaw_user }}"
    mode: "0600"
    force: false
    content: |
      OPENCLAW_CONFIG_DIR={{ openclaw_config_dir }}
      OPENCLAW_WORKSPACE_DIR={{ openclaw_install_dir }}/workspace
      OPENCLAW_GATEWAY_TOKEN=
      CLAUDE_AI_SESSION_KEY=
      CLAUDE_WEB_SESSION_KEY=
      CLAUDE_WEB_COOKIE=
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - deploy

- name: Run the Docker setup script
  ansible.builtin.command:
    cmd: ./docker-setup.sh
    chdir: "{{ openclaw_install_dir }}"
    creates: "{{ openclaw_install_dir }}/docker-compose.yml"
  become: true
  become_user: "{{ openclaw_user }}"
  tags:
    - deploy

- name: Check if onboarding has been completed
  ansible.builtin.stat:
    path: "{{ openclaw_config_dir }}/agents/"
  become: true
  become_user: "{{ openclaw_user }}"
  register: onboarding_check
  tags:
    - deploy

- name: Fail if onboarding has not been completed
  ansible.builtin.fail:
    msg: |
      OpenClaw onboarding has not been completed yet.

      Please SSH into the Mac Mini as the '{{ openclaw_user }}' user and run:
        cd {{ openclaw_install_dir }}
        docker compose run --rm openclaw-cli onboard

      During onboarding:
        - Select your model provider (Anthropic recommended)
        - Select Discord as your chat platform
        - Follow the prompts to set up your Discord bot

      After onboarding completes, re-run this playbook.
  when: not (onboarding_check.stat.exists | default(false))
  tags:
    - deploy
