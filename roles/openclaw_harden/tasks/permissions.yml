---
# tasks/permissions.yml â€” openclaw_harden role
#
# Locks down file and directory permissions for the OpenClaw config
# directory and any credential / auth-profile files within it.

- name: Set config directory permissions to 0700
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    mode: "0700"
  become: true
  tags:
    - harden
    - permissions

- name: Find credential files (creds.json)
  ansible.builtin.find:
    paths: "{{ openclaw_config_dir }}/credentials/"
    patterns: "creds.json"
    recurse: true
  become: true
  register: _credential_files
  tags:
    - harden
    - permissions

- name: Find auth-profile files (auth-profiles.json)
  ansible.builtin.find:
    paths: "{{ openclaw_config_dir }}/agents/"
    patterns: "auth-profiles.json"
    recurse: true
  become: true
  register: _auth_profile_files
  tags:
    - harden
    - permissions

- name: Set credential files to mode 0600
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ openclaw_user }}"
    mode: "0600"
  become: true
  loop: "{{ _credential_files.files + _auth_profile_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  tags:
    - harden
    - permissions
